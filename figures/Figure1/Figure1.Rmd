---
title: "EPI-clone Figure 1"
author: "Michael Scherer & Lars Velten"
date: "18/12/2024"
output: html_document
---

## Experimental design

This vignette describes how to generat the plots for Figure 1 of the EPI-Clone manuscript. Specically, it shows how the three experiments analysing HSPCs (M.1: LARRY main experiment, M.2: LARRY replicate experiment, M.3: Native hematopoiesis) analysed together provide a high-resolution, DNA-methylation-based UMAP of murine hematopoiesis.

![Three experiments were used and analyzed together to generate a low-dimensional representation of DNA methylation in murine HSPCs.](exp_overview_Fig1.png)

```{r setup, include=FALSE}
.libPaths(c(.libPaths(),"/home/mscherer/R/x86_64-pc-linux-gnu-library/4.2/"))
library(Seurat)
library(ggplot2)
library(viridis)
library(gridExtra)
library(corrplot)
library(harmony)
library(infotheo)
library(caret)
library(randomForest)
library(ComplexHeatmap)
library(uwot)
knitr::opts_chunk$set(echo = TRUE)
plot_theme_legend <- theme(panel.background = element_rect(color='black',fill='white'),
                          panel.grid=element_blank(),
                          text=element_text(color='black',size=10),
                          axis.text=element_text(color='black',size=10),
                          axis.ticks=element_line(color='black', size=.1),
                          strip.background = element_blank(),
                          legend.key=element_rect(color='black', fill=NA),
                          legend.key.size = unit(5, 'mm'),
                          strip.text = element_text(color='black',size=12))
plot_theme_title <- theme(panel.background = element_blank(),
                    panel.grid=element_blank(),
                    text=element_text(color='black',size=10),
                    axis.text=element_blank(),
                    axis.ticks=element_blank(),
                    axis.title=element_blank(),
                    strip.background = element_blank(),
                    legend.key=element_rect(color='black', fill=NA),
                    legend.key.size = unit(5, 'mm'),
                    legend.position = 'none',
                    strip.text = element_text(color='black',size=12),
                    plot.title = element_text(color='black',size=10))
plot_theme <- theme(panel.background = element_rect(color='black',fill='white'),
                    panel.grid=element_blank(),
                    text=element_text(color='black',size=12),
                    axis.text=element_text(color='black',size=10),
                    axis.ticks=element_line(color='black', size=.1),
                    strip.background = element_blank(),
                    legend.key=element_rect(color='black', fill=NA),
                    legend.key.size = unit(5, 'mm'),
                    plot.title=element_blank(),
                    legend.position = 'none',
                    strip.text = element_text(color='black',size=12))
color_map <- c("HSC/MPP1"="maroon4",
  "MPP2" ="darkgrey",
  "MPP3" = "darkblue",
  "MPP4" = "darkgreen",
  "pre/pro-B" ="#94B1F9",
  "GMP" = "#C3C380",
  'Myeloid Progenitors'="#C3C380",
  'Myelocytes'='#e5e500',
  "MEP"="#D5392C",
  "EryP" = "#ED7950",
  "MkP 1" = "#BDA8CB",
  "MkP" = "#BDA8CB",
  "MkP 2" = "#D36494"
  )
source('../../scripts/helper_functions.R')
source('../..//scripts/EPIClone.R')
```

This vignette shows some applications of EPI-clone in combination with the DNA methylation readout provided by scTAM-seq.

## Write amplicon csv

```{r panel}
panel <- read.table('../../infos/panel_info_dropout_pwm.tsv')
to_write <- panel[panel$DropoutUncutLKs>0.9, 'Type']
to_write <- to_write[to_write%in%c('HSC_high', 'MPP_high', 'MPPI_high', 'MPPII_high', 'WSH', 'IMR')]
to_write[to_write%in%c('HSC_high', 'MPP_high', 'MPPI_high', 'MPPII_high')] <- 'DMC'
write.csv(table(to_write), '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1B.csv')
```

## Differentiation uMAP (Figure 1c)

We simply load the data and visualize the integrated uMAP that shows three differentiation trajectories.

```{r differentiation_umap, warning=F, message=F}
seurat_obj <- readRDS(url('https://figshare.com/ndownloader/files/42479346'))
DimPlot(seurat_obj, group.by = "CellType",reduction="umap") + ggtitle("") + NoAxes() + NoLegend() + scale_color_manual(values = color_map)
write.csv(data.frame(seurat_obj@reductions$umap@cell.embeddings, CellType=seurat_obj$CellType), '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1C.csv')
```

## Cell type annotation with bulk profiles

To annotate the different clusters we identified, we leverage information from bulk data. Using this information, we can compute a relative methylation score for a subset of amplicons in each of the cells.

```{r bulk_methylation, fig.width=4,fig.height=4}
panel_file <- '../../infos/panel_info_dropout_pwm.tsv'
counts <- as.matrix(GetAssayData(seurat_obj,
                       'DNAm',
                       slot='counts'))
plot_hsc <- plot_type_methylation(seurat_obj,
                                  t(counts),
                                  type='HSC_high',
                                  panel = panel_file,
                                  export_to_plot=TRUE,
                                  export_file='/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1D1.csv')+
  plot_theme_title#+ggtitle('HSC high')
plot_mpp <- plot_type_methylation(seurat_obj,
                                  t(counts),
                                  type='MPP_high',
                                  panel = panel_file,
                                  export_to_plot=TRUE,                                  export_file='/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1D.csv')+
  plot_theme_title#+ggtitle('MPP3/4 high')
png('/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/final_revision/Figure1/hsc_mpp1.png', height=25, width=35, unit='mm', res=300)
grid.arrange(plot_hsc,
             plot_mpp,
             nrow=1)
dev.off()
```

## Surface protein expression per cell type 

In a first step, we only use data, where antibody staining was performed and remove cells from plotting that do not express any surface antibodies or where there is another potential issue with the antibody staining (unusually high expression of all surface markers).

```{r subset_data, message=FALSE, warning=FALSE}
seurat_ab <- subset(seurat_obj,
                    ProcessingBatch%in%c('LK_LSK_stained', 'LARRY_mouse3', 'LARRY_mouse4'))
```

We use CLR normalization, which is typically used for normalization of surface marker expression data.

```{r normalize_the_data, echo = F}
seurat_ab <- NormalizeData(seurat_ab,
                           assay = 'AB',
                           normalization.method = 'CLR')
adt_data <- t(as.matrix(GetAssayData(seurat_ab,
                         assay='AB',
                         slot = 'data')))
all_zeros <- apply(adt_data, 1, function(x)all(is.na(x), na.rm=TRUE))
adt_data[all_zeros, ] <- 0
all_zeros <- all_zeros|apply(adt_data, 1, function(x)all(x>1, na.rm = TRUE))
seurat_ab <- seurat_ab[, !all_zeros]
adt_data[is.na(adt_data)] <- 0
plot_dat <- data.frame(seurat_ab[[]], adt_data[!all_zeros, ])
```

For plotting purposes, we only use the surface markers, SCA-1, cKIT, CD48, CD150, CD135 and CD201, which are commonly used for sorting different HSPC (HSC and MPP) populations.

```{r plot_ab_data the data, echo = F}
sca1_gate <- 2
ckit_gate <- 1
extension <- '.raw'
abs <- c('SCA1',
         'cKIT')
to_plot <- data.frame(plot_dat[, c(paste0(abs, extension),'CellType')])
colnames(to_plot)[1:2] <-abs
write.csv(to_plot,                             '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1G1.csv')
plot1 <- ggplot(to_plot, aes_string(x='SCA1', y='cKIT', color='CellType'))+
  geom_point(size=.5, stroke=.5)+
  geom_vline(xintercept = sca1_gate)+geom_hline(yintercept = ckit_gate)+
  plot_theme+scale_color_manual(values=color_map)

plot_dat <- plot_dat[which(plot_dat[, paste0('SCA1', extension)]>sca1_gate&plot_dat[, paste0('cKIT', extension)]>ckit_gate), ]
abs <- c('CD201',
         'CD135')
to_plot <- data.frame(plot_dat[, c(paste0(abs, extension),'CellType')])
colnames(to_plot)[1:2] <- abs
write.csv(to_plot,                              '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1G2.csv')
plot2 <- ggplot(to_plot, aes_string(x=abs[1], y=abs[2], color='CellType'))+
  geom_vline(xintercept = 1)+geom_hline(yintercept = 1)+
  geom_jitter(size=.5, stroke=.5, width = .1, height = .1)+
  plot_theme+scale_color_manual(values=color_map)

abs <- c('CD48',
         'CD150')
to_plot <- data.frame(plot_dat[, c(paste0(abs, extension),'CellType')])
colnames(to_plot)[1:2] <- abs
write.csv(to_plot,                              '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1F.csv')
plot3 <- ggplot(to_plot, aes_string(x=abs[1], y=abs[2], color='CellType'))+
  geom_point(size=.5, stroke=.5)+
  geom_vline(xintercept = 1)+geom_hline(yintercept = 1)+
  plot_theme+scale_color_manual(values=color_map)

png('/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/final_revision/Figure1/ab_expression.png', height=37.5, width=97.5, unit='mm', res=300)
grid.arrange(plot1,
             plot2,
             plot3,
             nrow=1)
dev.off()
```

## Visualize TFBS methylation

By using the methylation at CpGs located in the vicinity of a TFBS, we can compute a relative methylation state for each cell. This shows where the HSCs/MPPs are located in the UMAP and how TFBS become de-methylated with differentiation.

```{r tfbs_methylation, fig.width=4,fig.height=4}
plot_gata2 <- plot_tfbs_methylation(seurat_obj,
                      t(counts),
                      panel=panel_file,
                      'Gata2_ChIP',
                      export_to_plot=FALSE)+plot_theme_title+ggtitle('Gata2')
plot_spi <- plot_tfbs_methylation(seurat_obj,
                                   t(counts),
                                   panel=panel_file,
                                   'Spi1',
                                  export_to_plot=FALSE)+plot_theme_title+ggtitle('Spi1')
grid.arrange(plot_gata2,
             plot_spi,
             nrow=2)
```

## TFBS enrichment

To extend upon the analysis above, we investigate many important hematopoietic TFs with respect to their DNA methylation state in our data. Specifically, we define CpG that are specifically unmethylated in a cell type and scan for enrichment of TFBS.

```{r tfbs_enrichment}
Idents(seurat_obj) <- 'CellType'
panel <- read.table(panel_file,
                    sep='\t')
markers_hsc <- differential_test(seurat_obj,
                            ident.1 = 'HSC/MPP1')
enrichments_hsc <- run_marker_enrichment(markers_hsc,
                                          panel,
                                          fc.cut = 0.5)
markers_mkp1 <- differential_test(seurat_obj,
                                  ident.1 = 'MkP 1')
enrichments_mkp1 <- run_marker_enrichment(markers_mkp1,
                                          panel,
                                          fc.cut = 0.5)
markers_mkp2 <- differential_test(seurat_obj,
                                  ident.1 = 'MkP 2')
enrichments_mkp2 <- run_marker_enrichment(markers_mkp2,
                                          panel,
                                          fc.cut = 0.5)
markers_mpp2 <- differential_test(seurat_obj,
                                  ident.1 = 'MPP2')
enrichments_mpp2 <- run_marker_enrichment(markers_mpp2,
                                          panel,
                                          fc.cut = 1)
markers_mpp3 <- differential_test(seurat_obj,
                            ident.1 = 'MPP3')
enrichments_mpp3 <- run_marker_enrichment(markers_mpp3,
                                          panel,
                                          fc.cut = 1)
markers_mpp4 <- differential_test(seurat_obj,
                           ident.1 = 'MPP4')
enrichments_mpp4 <- run_marker_enrichment(markers_mpp4,
                                         panel,
                                         fc.cut = 1)
markers_preb <- differential_test(seurat_obj,
                            ident.1 = 'pre/pro-B')
enrichments_preb <- run_marker_enrichment(markers_preb,
                                          panel,
                                          fc.cut = 1)
markers_myo <- differential_test(seurat_obj,
                                    ident.1 = 'GMP')
enrichments_myo <- run_marker_enrichment(markers_myo,
                                            panel,
                                            fc.cut = 1)
markers_meg <- differential_test(seurat_obj,
                              ident.1 = 'MEP')
enrichments_meg <- run_marker_enrichment(markers_meg,
                                            panel,
                                            fc.cut = 1)
markers_ery <- differential_test(seurat_obj,
                           ident.1 = 'EryP')
enrichments_ery <- run_marker_enrichment(markers_ery,
                                         panel,
                                         fc.cut = 1)
all_tfs <- unique(c(enrichments_hsc$Negative$TFBS$x,
                    #enrichments_mkp1$Negative$TFBS$x,
                    enrichments_mkp2$Negative$TFBS$x,
                    enrichments_mpp2$Negative$TFBS$x,
                    enrichments_mpp3$Negative$TFBS$x,
                    enrichments_mpp4$Negative$TFBS$x,
                    enrichments_preb$Negative$TFBS$x,
                    enrichments_myo$Negative$TFBS$x,
                    enrichments_meg$Negative$TFBS$x,
                    enrichments_ery$Negative$TFBS$x))
to_plot <- matrix(1, nrow=length(all_tfs), ncol=10)
row.names(to_plot) <- all_tfs
colnames(to_plot) <- c('HSC/MPP1',
                       'MPP2',
                       'MPP3',
                       'MPP4',
                       'pre/pro-B',
                       'GMP',
                       'MEP',
                       'EryP',
                       'MkP 1',
                       'MkP 2')
to_plot[enrichments_hsc$Negative$TFBS$x, 'HSC/MPP1'] <- enrichments_hsc$Negative$TFBS$enrichment
to_plot[, 'MkP 1'] <- 1
to_plot[enrichments_mkp2$Negative$TFBS$x, 'MkP 2'] <- enrichments_mkp2$Negative$TFBS$enrichment
to_plot[enrichments_mpp2$Negative$TFBS$x, 'MPP2'] <- enrichments_mpp2$Negative$TFBS$enrichment
to_plot[enrichments_mpp3$Negative$TFBS$x, 'MPP3'] <- enrichments_mpp3$Negative$TFBS$enrichment
to_plot[enrichments_mpp4$Negative$TFBS$x, 'MPP4'] <- enrichments_mpp4$Negative$TFBS$enrichment
to_plot[enrichments_preb$Negative$TFBS$x, 'pre/pro-B'] <- enrichments_preb$Negative$TFBS$enrichment
to_plot[enrichments_myo$Negative$TFBS$x, 'GMP'] <- enrichments_myo$Negative$TFBS$enrichment
to_plot[enrichments_meg$Negative$TFBS$x, 'MEP'] <- enrichments_meg$Negative$TFBS$enrichment
to_plot[enrichments_ery$Negative$TFBS$x, 'EryP'] <- enrichments_ery$Negative$TFBS$enrichment

to_plot <- to_plot[c(row.names(to_plot)[grepl('ChIP', row.names(to_plot))],
                     row.names(to_plot)[!grepl('ChIP', row.names(to_plot))]),]
rem_tfs <- apply(to_plot, 1, function(x)all(x>0.01))
to_plot <- to_plot[!rem_tfs, ]
to_plot <- to_plot[c('Scl_ChIP',
                     'Lyl1_ChIP',
                     'Lmo2_ChIP',
                     'Erg_ChIP',
                     'Fli-1_ChIP',
                     'Gata2_ChIP',
                     'Runx1_ChIP',
                     'Meis2',
                     'Gata1',
                     'Stat5a',
                     'Ebf1',
                     'Myb',
                     'Spi1'), ]
write.csv(to_plot, '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1E.csv')
corrplot(-log10(t(to_plot+1e-6)),
         is.corr = FALSE,
         tl.col = 'black',
         col=inferno(50),
         col.lim=c(-1, 7),
         tl.cex = 1,
         cl.cex = 1)
```

## Plot HSC score and overall methylation

To better characterize all cell populations, we computed the average methylation value in HSC-specific CpGs as well as the average methylation state across all CpGs in our panel.

```{r hsc_score}
sel_amplicons <- row.names(subset(panel, subset=Type=='HSC_high'))
hsc_score <- colSums(counts[intersect(sel_amplicons, rownames(counts)), ]>0)/length(sel_amplicons)
meth <- colSums(counts>0)/nrow(counts)
to_plot <- data.frame(Cluster=seurat_obj$CellType, HSCScore=hsc_score, Methylation=meth)
to_plot$Cluster <- factor(to_plot$Cluster, levels=names(color_map))
plot_hsc <- ggplot(to_plot, aes(x=Cluster, y=HSCScore, fill=Cluster))+geom_boxplot(outlier.size = .5)+
  plot_theme+theme(axis.text.x = element_blank())+scale_fill_manual(values = color_map)+
  xlab('')
plot_meth <- ggplot(to_plot, aes(x=Cluster, y=Methylation, fill=Cluster))+geom_boxplot(outlier.size = .5)+
  plot_theme+theme(axis.text.x = element_text(angle=45, hjust=1))+scale_fill_manual(values = color_map)+
  xlab('')+ylab('Overall methylation')
grid.arrange(plot_hsc, plot_meth, layout_matrix=as.matrix(c(1,1,2,2,2)))
```


## Transcriptomic uMAP

```{r transcriptomic_umap, warning=F, message=F}
#seurat_rna <- readRDS(url("https://figshare.com/ndownloader/files/42587815"))
seurat_rna <- readRDS("/home/mscherer/cluster/project/Methylome/analysis/HSCs/GeX/LARRY/objects/seurat_LK_LSK.RDS")
DimPlot(seurat_rna, group.by = "CellType", reduction = "umap_harmony") + ggtitle("") + NoAxes() + NoLegend() + scale_color_manual(values = color_map)
write.csv(data.frame(seurat_rna@reductions$umap_harmony@cell.embeddings, CellType=seurat_rna$CellType), '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/ExtFigure2/source_data/Fig2A.csv')
```

## Compare information content on cell types

To compare the information content encoded in both modalities, we trained RandomForest classifiers and then compared the information content with the entropy of all cell types.

```{r infotheo, eval=FALSE}
control <- trainControl(method='repeatedcv', 
                        number=10, 
                        repeats=1)
counts_dnam <- GetAssayData(seurat_obj,
                            slot='counts',
                            assay='DNAm')
pred_dat <- data.frame(CellType=as.factor(seurat_obj$CellType),
                       t(as.matrix(counts_dnam)))
rf_dnam <- randomForest(CellType~., 
                 data=pred_dat)
counts_rna <- GetAssayData(seurat_rna,
                           slot='data',
                           assay='RNA')
counts_rna <- counts_rna[VariableFeatures(seurat_rna), ]
pred_dat_rna <- data.frame(CellType=as.factor(seurat_rna$CellType),
                           t(as.matrix(counts_rna)))
rf_rna <- randomForest(CellType~., 
                        data=pred_dat_rna)
unex_dnam <- entropy(seurat_obj$CellType)
ex_dnam <- mutinformation(seurat_obj$CellType,
                          rf_dnam$predicted)
unex_rna <- entropy(seurat_rna$CellType)
ex_rna <- mutinformation(seurat_rna$CellType,
                         rf_rna$predicted)

to_plot <- data.frame(Modality = rep(c("RNA","DNAm"), each =2),
                  Type = rep(c("Unexplained", "Full"), 3),
                  Information = natstobits(c(unex_rna, ex_rna, unex_dnam, ex_dnam)))

ggplot(to_plot, aes(x = Modality, y = Information, fill = Type)) + geom_col(position = position_identity()) +
  scale_fill_manual(values = c("Unexplained" = "darkgrey","Full" = "darkred"), name = "") +
  plot_theme + ylab("Information on Cell Types (bits)") + xlab("Modality")
```

## Identify MkP 1 and MkP 2 in RNA (Figure S2)

Since we can associate a particular LARRY barcode in the two modalities, we can investigate whether we can detect the two populations MkP 1 and MkP 2 in the RNA UMAP.

As a first step, we search for the DNAm LARRY barcodes in the RNA modality.

```{r larry_in_rna}
hsc_barcodes <- unique(na.omit(seurat_obj$LARRY[seurat_obj$CellType%in%'HSC/MPP1']))
mkp1_barcodes <- unique(na.omit(seurat_obj$LARRY[seurat_obj$CellType%in%'MkP 1']))
mkp2_barcodes <- unique(na.omit(seurat_obj$LARRY[seurat_obj$CellType%in%'MkP 2']))

seurat_rna$HSCCousin <- factor(ifelse(seurat_rna$LARRY%in%hsc_barcodes, 'Cousin', 'Other'), levels=c('Cousin', 'Other'))
seurat_rna$MkP1Cousin <- factor(ifelse(seurat_rna$LARRY%in%mkp1_barcodes, 'Cousin', 'Other'), levels=c('Cousin', 'Other'))
seurat_rna$MkP2Cousin <- ifelse(seurat_rna$LARRY%in%mkp2_barcodes, 'Cousin', 'Other')
seurat_rna$Cousins <- ifelse(seurat_rna$LARRY%in%mkp1_barcodes&seurat_rna$LARRY%in%hsc_barcodes,
                             'HSC&MkP 1', 
                             ifelse(seurat_rna$LARRY%in%mkp1_barcodes, 'MkP 1',
                                    ifelse(seurat_rna$LARRY%in%hsc_barcodes, 'HSC', 'Other')))
to_plot <- as.data.frame(seurat_rna[['umap_harmony']]@cell.embeddings)
to_plot <- data.frame(to_plot, Cousins=factor(seurat_rna$Cousins, levels=rev(c('MkP 1', 'HSC', 'HSC&MkP 1', 'Other'))))
to_plot$Cousins[!(seurat_rna$CellType%in%c('HSC/MPP1', 'MkP'))] <- 'Other'
to_plot <- to_plot[order(to_plot$Cousins), ]
ggplot(to_plot, aes(x=umapharmony_1, y=umapharmony_2, color=Cousins, size=Cousins))+geom_point(stroke=.5)+
plot_theme_title+guides(color = guide_legend(override.aes = list(size = 3.5), title='Cousins'))+
  scale_color_manual(values=c('HSC&MkP 1'='darkgreen',
                                    'MkP 1'='#0088aa',
                                    'HSC'='maroon4',
                                    'Other'='gray75'))+scale_size_manual(values=c('HSC&MkP 1'=2,
                                    'MkP 1'=2,
                                    'HSC'=2,
                                    'Other'=.5))+NoAxes()+ggtitle("")+NoGrid()

```

```{r mkp1_mkp2_ab}
seurat_ab <- subset(seurat_obj,
                    ProcessingBatch%in%c('LK_LSK_stained', 'LARRY_mouse3', 'LARRY_mouse4'))
adt_data <- t(as.matrix(GetAssayData(seurat_ab,
                                     assay='AB')))
all_zeros <- apply(adt_data, 1, function(x)all(is.na(x), na.rm=TRUE))
adt_data[all_zeros, ] <- 0
all_zeros <- all_zeros|apply(adt_data, 1, function(x)all(x>1, na.rm = TRUE))
seurat_ab <- seurat_ab[, !all_zeros]
adt_data <- GetAssayData(seurat_ab,
                         assay='AB')
adt_data[is.na(adt_data)] <- 0
adt_dnam <- data.frame(CellType=seurat_obj[[]][colnames(adt_data), 'CellType'], t(adt_data[c("CD49f-raw", "CD150-raw", "CD48-raw", "CD41-raw"), ]))
adt_dnam <- subset(adt_dnam, CellType%in%c('HSC/MPP1', 'MkP 1', 'MkP 2'))
colnames(adt_dnam)[2:5] <- c('CD49f', 'CD150', 'CD48', 'CD41')
seurat_rna_ab <- subset(seurat_rna, ProcessingBatch%in%c('LARRY_mouse1', 'LARRY_mouse2', 'LARRY_mouse3', 'LARRY_mouse4', 'LK_LSK_stained'))
adt_rna <- data.frame(CellType=seurat_rna[[]][Cells(seurat_rna_ab), 'CellType'], t(GetAssayData(seurat_rna_ab, slot='data', assay='AB')[c("CD49f-totalseqb", "CD150-totalseqb", "CD48-totalseqb", "CD41-totalseqb"), ]))
adt_rna <- subset(adt_rna, CellType%in%c('HSC/MPP1', 'MkP'))
colnames(adt_rna)[2:5] <- c('CD49f', 'CD150', 'CD48', 'CD41')
to_plot <- reshape2::melt(adt_dnam, id='CellType')
plot_dnam <- ggplot(to_plot, aes(x=CellType, y=value, fill=CellType))+geom_boxplot(outlier.size = .5)+plot_theme+facet_wrap(variable~., nrow=1)+scale_fill_manual(values=color_map)+ylab('Protein expression')+theme(axis.text.x = element_text(angle=45, hjust=1))+xlab('')
to_plot <- reshape2::melt(adt_rna, id='CellType')
plot_rna <- ggplot(to_plot, aes(x=CellType, y=value, fill=CellType))+geom_boxplot(outlier.size = .5)+plot_theme+facet_wrap(variable~., nrow=1)+scale_fill_manual(values=c('HSC/MPP1'='maroon4', 'HSC1'='maroon2', 'HSC2'='maroon1', 'HSC3'='maroon3', color_map))+ylab('Protein expression')+theme(axis.text.x = element_text(angle=45, hjust=1))+xlab('')
grid.arrange(plot_dnam, plot_rna, nrow=2)
```

## Unsupervised uMAP (Figure 1b,c)

First we load the data and perform an unsupervised dimensionality reduction of all CpGs.

```{r readData, warning=F, message=F}
require(Seurat)
require(ggplot2)
require(ROCR)
require(fossil)
require(reshape2)
require(pheatmap)
require(GenomicRanges)
full_seurat <- readRDS("/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/processing/EPI_clone_seurat.RDS")
larry <- subset(full_seurat, Experiment == "LARRY main experiment")
```

We perform straightforward Seurat dimensionality reduction

```{r full_seurat, message=FALSE, warning=FALSE}
usecpg <- rownames(larry)
larry <- ScaleData(larry, assay = "DNAm", features = usecpg, verbose = F)
larry <- RunPCA(larry, assay = "DNAm", features = usecpg, reduction.name = "pca", reduction.key = "PC_", npcs = 100, verbose = F)
larry <- RunUMAP(larry, reduction = "pca", dims = 1:50, verbose = F)
```


```{r setupcolors, echo = F}
cloneorder <- table(larry$LARRY)
bigclones <- names(cloneorder)[cloneorder > 30]
cloneorder <- names(cloneorder)[order(cloneorder, decreasing = T)]
cloneColors.here <- scales::grey_pal(end = 1)(length(unique(cloneorder)))
names(cloneColors.here) <- cloneorder
cloneColors.here[bigclones] <- scales::hue_pal()(length(bigclones))
```


We can highlight on this the *Celltype* annotation. See the other vignette on how it was obtained.

```{r fig1b_celltype_all, fig.width=4,fig.height=4}
celltypeColors <- c("HSC/MPP1"="maroon4",
                    "MPP2" ="darkgrey",
                    "MPP3" = "darkblue",
                    "MPP4" = "darkgreen",
                    "MEP"="#D5392C",
                    "EryP" = "#ED7950",
                    "MkP 1" = "#BDA8CB",
                    "MkP 2" = "#D36494",
                    "GMP" = "#C3C380",
                    "pre/pro-B" ="#94B1F9")
DimPlot(larry, group.by = "CellType",reduction="umap") + ggtitle("") + NoAxes() + NoLegend() + scale_color_manual(values = celltypeColors)
write.csv(data.frame(larry@reductions$umap@cell.embeddings, CellType=larry$CellType), '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1G.csv')
```

In the main figure of the manuscript we show only the cells that carry a LARRY barcode. The cells where no LARRY barcode was observed (`r sprintf("%.1f %%", 100*mean(is.na(larry$LARRY)))` of cells - due to dropout, or cells falsely sorted as LARRY+ in the FACS) follow a similar distribution.

```{r fig1b_clone_all, fig.width=6,fig.height=4}
larry$use <- ifelse(!is.na(larry$LARRY), "LARRY barcode", "no LARRY barcode")
DimPlot(larry, group.by = "LARRY",reduction="umap", order=cloneorder, split.by = "use") + ggtitle("") + NoAxes() + NoLegend() + scale_color_manual(values = cloneColors.here)
write.csv(data.frame(larry@reductions$umap@cell.embeddings[larry$use=="LARRY barcode", ], LARRY=larry$LARRY[larry$use=="LARRY barcode"]), '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1H.csv')

```

Here, different shades of grey correspond to different LARRY clones represented with up to 30 cells and different colors correspond to different LARRY clones represented with >30 cells.

This plot suggests that overall, the methylome is impacted both by differentiation state and the clonal identity.

## Identification of static CpGs (Figure 1d)

To more cleanly identify clones, EPI-Clone first looks for CpGs that are *not* associated with differentiation. We use surface antigen expression as a proxy for differentiation, since it is completely independent of methylation; alternatively, if you have good cell state annotation obtained from methylation (see also other vignette on cell state), this can be used as well.  The `epiclone` wrapper function can handle both cases.

```{r epiclone_pt1a, warning=FALSE, message=FALSE}

  #compute minimum pvalue for asociation with (any) protein
  suppressWarnings({
    
  pvals <- apply(larry@assays$DNAm@data,1, function(met) {
    apply(larry@assays$AB@data, 1, function(prot) {
      use <- !is.na(prot)
      a <- prot[use][met[use]==1]
      b <- prot[use][met[use]==0]
      if (length(a) < 3 | length(b) < 3) return(1) else return(ks.test(a,b)$p.value)
    })
  })
  min_pval <- apply(pvals,2,min)
  
  #establish bonferroni criterion
  thr.protein.ass <- 1/(nrow(larry@assays$DNAm@data) * nrow(larry@assays$AB@data))
  
  #determine average overall methylation level
  avg_meth_rate <- apply(larry@assays$DNAm@data, 1, mean)
  })
```


We use the LARRY labels to compute, for each CpG, the statistical association with clone (more accurately, any clone bigger than 30 cells). This value is only used for plotting but not for selecting CpGs, so of course, EPI-Clone also workd without clonal labels

```{r epiclone_pt1b, fig.width=5,fig.height=3}
trueClone <- "LARRY"
ncells.bigClone <- 30
upper.thr.methrate <- 0.9
lower.thr.methrate <- 0.25
true_clone <- larry@meta.data[,trueClone]
for_prediction <- larry

for_prediction$use <- !is.na(true_clone)
for_prediction <- subset(for_prediction, use)
a <-table(for_prediction@meta.data[,trueClone])
use_for_prediction <- names(a)[a > ncells.bigClone]
for_prediction$use <- for_prediction@meta.data[,trueClone] %in% use_for_prediction
for_prediction <- subset(for_prediction,use)

cloneid <- factor(for_prediction@meta.data[,trueClone], levels = unique(for_prediction@meta.data[,trueClone]))
suppressWarnings({
  pvals_cloneass <- p.adjust(apply(for_prediction@assays[["DNAm"]]@data,1,function(met) {
  chisq.test(table(met,cloneid))$p.value
}),method = "bonferroni")
})

CpGSelection <- data.frame(CpG = names(pvals_cloneass), avg_meth_rate, min_pval, pvals_cloneass)
selected_not_protein <- names(min_pval)[min_pval > thr.protein.ass & avg_meth_rate < upper.thr.methrate & avg_meth_rate > lower.thr.methrate]
CpGSelection$Type <- ifelse(row.names(CpGSelection)%in%selected_not_protein, 'Static', 'Dynamic')
write.csv(CpGSelection, 'cpg_selection.csv')
panel <- read.table('/home/mscherer/cluster/project/Methylome/infos/HSCs/panel_info_dropout_pwm.tsv',
                    sep='\t',
                    header=TRUE)

to_plot <- data.frame(PVal=min_pval,
                      AvgMeth=avg_meth_rate,
                      PValClone=pvals_cloneass)
write.csv(to_plot, '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1I.csv')

ggplot(to_plot, aes(x = AvgMeth, y = log10(ifelse(PVal<1e-21, 1e-21, PVal)), color = -log10(PValClone+1e-50)))+
  geom_point(size=.5, stroke=.5)+
  geom_hline(yintercept = log10(thr.protein.ass)) + geom_vline(xintercept = c(lower.thr.methrate,upper.thr.methrate)) +
  plot_theme + xlab("Average methylation") + ylab(ifelse(is.null(thr.protein.ass), "p value cell state association", "Association with surface\nprotein [log10]")) +
  scale_color_gradientn(colours = c("black","blue","red"), name = "-log10 p-val\nClone association")+
  scale_y_continuous(breaks=c(0, -7.5, -15), limits = c(-22,5))

ggsave('/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/final_revision/Figure1/static_dynamic.pdf',
       height=55, width=45, unit='mm')
```

The `r sprintf("n = %d", length(selected_not_protein))` dots in the upper central rectangle of this plot (Figure 1D) are of interest as static CpGs and used further for clustering of clones

## Check the localization of static vs. dynamic CpGs (Figure 1e)

```{r clonal_CpGs_genomic_distribution, fig.width=5,fig.height=3}
cols_chrom <- c('active/weak promoter'='#ff678c',
          'Enhancer'='#ffdc64',
          'transcription'='#008c64',
          'Heterochromatin'='#6e1e8c',
          'weak enhancer'='#ffff00',
          'H3K9me3-repressed'='#787878',
          'Other'='#aaaaaa',
          'H3K9me3-repressed'='#f0f0f0')
#panel_info <- read.table('infos/panel_info_dropout_pwm.tsv',
panel_info <- read.table('/home/mscherer/cluster/project/Methylome/infos/HSCs/panel_info_dropout_pwm.tsv',
                         sep='\t')
plot_dat <- panel_info[row.names(CpGSelection), 'ChromState', drop=FALSE]
plot_dat$ChromState <- c("active/weak promoter"='Other',
                        "heterochromatin"="Heterochromatin",
                        "poised promoter"='Other',
                        "strong enhancer"='Enhancer',
                        "transcription"='Other',
                        "weak enhancer"='Enhancer')[plot_dat$ChromState]
plot_dat$Type <- ifelse(row.names(plot_dat)%in%selected_not_protein, 'static', 'dynamic')
to_plot_dynamic <- plyr::count(plot_dat[plot_dat$Type=='dynamic', ])
to_plot_static <- plyr::count(plot_dat[plot_dat$Type=='static', ])
to_plot_dynamic$freq <- to_plot_dynamic$freq/sum(to_plot_dynamic$freq)
to_plot_static$freq <- to_plot_static$freq/sum(to_plot_static$freq)
to_plot <- rbind(to_plot_dynamic, to_plot_static)
write.csv(to_plot, '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/source_data/Fig1J.csv')
fisher.p <- fisher.test(table(plot_dat[plot_dat$ChromState!='Other', c('Type', 'ChromState')]))
ggplot(to_plot, aes(x=Type, y=freq*100, fill=ChromState))+geom_bar(stat = 'identity')+plot_theme+scale_fill_manual(values=cols_chrom)+xlab('CpG Class')+ylab('%of CpGs in chromatin state')
ggsave('/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/final_revision/Figure1/chromatin.pdf',
       height=48, width=27, unit='mm')
```
Static CpGs are enriched in heterochromatic regions with p-value `r paste(fisher.p$p.value)`.

```{r repli_timing}
repli_data <- as.data.frame(read.table('/home/mscherer/cluster/project/Methylome/infos/HSCs/repli_seq/GSE95091_46C_repli-seq_mm10_log_ratio_scaled.bedGraph.gz',
                                         sep='\t'))
repli_data_gr <- makeGRangesFromDataFrame(repli_data,
                                          seqnames.field = 'V1',
                                          start.field = 'V2',
                                          end.field = 'V3',
                                          keep.extra.columns = TRUE)
repli_signal <- as.numeric(repli_data$V4)
panel.gr <-  makeGRangesFromDataFrame(panel_info, seqnames.field = 'chr', start.field = 'amplicon_start', end.field = 'amplicon_end')
op <- findOverlaps(panel.gr, repli_data_gr, select = 'first')
panel_info$RepliSignal <- repli_signal[op]
panel_info$RepliDisc <- ifelse(panel_info$RepliSignal>0, 'Early', 'Late')
CpGSelection <- read.csv('/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/cpg_selection.csv', row.names = 1)
plot_dat <- panel_info[row.names(CpGSelection), 'RepliDisc', drop=FALSE]
plot_dat <- data.frame(plot_dat[ ,'RepliDisc', drop=FALSE], CpGSelection)
plot_dat <- na.omit(plot_dat)
to_plot_dynamic <- plyr::count(plot_dat[plot_dat$Type=='Dynamic', ])
to_plot_static <- plyr::count(plot_dat[plot_dat$Type=='Static', ])
to_plot_dynamic$freq <- to_plot_dynamic$freq/sum(to_plot_dynamic$freq)
to_plot_static$freq <- to_plot_static$freq/sum(to_plot_static$freq)
to_plot <- rbind(to_plot_dynamic, to_plot_static)
write.csv(to_plot, '/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/ExtFigure2/source_data/Fig2G.csv')
fisher.p <- fisher.test(table(plot_dat[, c('Type', 'RepliDisc')]))
ggplot(to_plot, aes(x=Type, y=freq*100, fill=RepliDisc))+geom_bar(stat = 'identity')+plot_theme+xlab('CpG Class')+ylab('%of CpGs in replicating domain')+scale_fill_manual(values=c('Early'='#ff678c','Late'='#008c64'))
ggsave(file.path('/home/mscherer/cluster/project/Methylome/analysis/HSCs/paper/revision/figures/Figure1/replication_timing.pdf'), height=50, width=35, unit='mm')
```
Static CpGs are enriched in late replicating domains with p-value `r paste(fisher.p$p.value)`.

